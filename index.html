<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VP Gold - Cat√°logo Profesional</title>
    
    <!-- Seguridad HTTPS -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- Vinculaci√≥n de Estilos -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Librer√≠as Externas -->
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body>

    <!-- =========================================
         0. COMPONENTES FLOTANTES
         ========================================= -->
    
    <!-- Bot√≥n Volver Arriba -->
    <button id="btn-back-to-top" class="btn-floating-top" onclick="irArriba()" title="Subir" aria-label="Volver arriba">
        <i class="ph ph-arrow-up"></i>
    </button>

    <!-- Notificaci√≥n Toast
         USABLE: Cambia el texto por defecto si quieres, pero muestra mensajes
         din√°micos con la funci√≥n `mostrarToast(mensaje)` en JS. Se oculta por
         defecto y usa la clase `show` para mostrarse. -->
    <div id="toast-notification" class="toast" role="status" aria-live="polite" style="display:none;">
        <div class="toast-content">
            <i class="ph ph-check-circle-fill"></i>
            <span id="toast-message">Acci√≥n realizada correctamente</span>
        </div>
    </div>

    <!-- Confirmaci√≥n de √©xito (alerta animada con flecha verde) -->
    <div id="success-alert" class="success-alert" aria-hidden="true">
        <div class="success-card">
            <div class="success-icon"><i class="ph ph-arrow-up-right"></i></div>
            <div class="success-text" id="success-text">Agregado exitosamente</div>
        </div>
    </div>

    <!-- Alerta Personalizada (CORREGIDA: Oculta por defecto) -->
    <div id="custom-alert" class="custom-alert-overlay" style="display: none;">
        <div class="custom-alert-box">
            <div class="alert-icon"><i class="ph ph-warning-circle"></i></div>
            <h3 id="alert-title">Atenci√≥n</h3>
            <p id="alert-message">Mensaje...</p>
            <button class="btn-alert" onclick="cerrarAlerta()">ENTENDIDO</button>
        </div>
    </div>

    <!-- =========================================
         1. TOP TICKER
         ========================================= -->
    <div class="top-ticker">
        <div class="ticker-wrapper">
            <button class="ticker-control" onclick="cambiarMensaje(-1)"><i class="ph ph-caret-left"></i></button>
            <div class="ticker-text" id="ticker-display"></div>
            <button class="ticker-control" onclick="cambiarMensaje(1)"><i class="ph ph-caret-right"></i></button>
        </div>
    </div>

    <!-- =========================================
         2. NAVBAR
         ========================================= -->
    <nav data-aos="fade-down" data-aos-duration="800">
        <div class="nav-content">
            <div class="buscador-container">
                <div class="input-wrapper">
                    <input type="text" id="input-busqueda" placeholder="Buscar productos..." onkeyup="filtrarBusqueda()" onkeypress="verificarEnter(event)" autocomplete="off">
                    <i class="ph ph-magnifying-glass icono-lupa"></i>
                </div>
                <div id="resultados-busqueda" class="lista-resultados"></div>
            </div>

            <div class="nav-buttons">
                <button class="btn-icon-nav" id="btn-carrito" onclick="abrirCarrito()">
                    <i class="ph ph-shopping-cart"></i>
                    <span id="carrito-count" class="badge-count">0</span>
                </button>
                <a href="https://www.instagram.com/acyn_vp/" target="_blank" class="btn-instagram">
                    <i class="ph ph-instagram-logo"></i>
                    <span class="texto-insta">Instagram</span>
                </a>
                <button class="btn-inicio" onclick="irAlInicio()"><i class="ph ph-house"></i></button>
            </div>
        </div>
    </nav>

    <!-- =========================================
         3. PANTALLA PRINCIPAL (PORTADAS)
         ========================================= -->
    <section id="seccion-categorias" class="pantalla-activa">
        <header data-aos="zoom-in" data-aos-duration="1200">
            <div class="header-overlay">
                <h1 class="texto-oro-liquido">VP</h1>
                <h2 class="subtitulo-vip">VIP ACAYUCAN</h2>
                <div class="separador-dorado"></div>
                <p class="slogan">CALIDAD & EXCLUSIVIDAD</p>
            </div>
        </header>

        <div class="contenedor-categorias" id="contenedor-categorias-dinamico"></div>
    </section>

    <!-- =========================================
         4. PANTALLA GRID (PRODUCTOS)
         ========================================= -->
    <section id="seccion-grid" class="pantalla-oculta">
        <div class="grid-header-spacer"></div>
        <div class="grid-productos" id="grid-productos"></div>
        <div class="espacio-final"></div>
    </section>

    <!-- =========================================
         5. MODAL DE PEDIDO
         ========================================= -->
    <div id="modal-pedido" class="modal">
        <div class="modal-content">
            <button class="cerrar-modal" onclick="cerrarModal()"><i class="ph ph-x"></i></button>
            <div class="modal-body">
                <div class="producto-header">
                    <div class="producto-imagen-grande">
                        <img id="modal-img" src="" alt="Producto">
                    </div>
                    <div class="producto-info-base">
                        <h2 id="modal-titulo-producto">Nombre</h2>
                        <p id="modal-modelo-producto" class="modelo-texto">Modelo</p>
                        <div class="precio-container">
                             <div id="contenedor-precio-modal"></div>
                             <span class="stock-badge"><i class="ph ph-check-circle"></i> Disponible</span>
                        </div>
                    </div>
                </div>
                <hr class="separador-modal">
                <div class="formulario-pedido">
                    <div class="grupo-input">
                        <label id="titulo-variantes">Opci√≥n:</label>
                        <div id="contenedor-variantes"></div>
                        <input type="hidden" id="variante-seleccionada-valor">
                    </div>
                    <div class="fila-controles">
                        <div class="control-cantidad-wrapper">
                            <label>Cantidad</label>
                            <div class="control-cantidad">
                                <button class="btn-cant" type="button" onclick="cambiarCantidad(-1)"><i class="ph ph-minus"></i></button>
                                <input type="number" id="cantidad-seleccionada" value="1" min="1" max="10" readonly>
                                <button class="btn-cant" type="button" onclick="cambiarCantidad(1)"><i class="ph ph-plus"></i></button>
                            </div>
                        </div>
                        <div class="metodo-pago-wrapper">
                            <label>Pago</label>
                            <div class="toggle-pago">
                                <input type="radio" name="pago" id="pago-transf" value="Transferencia" checked>
                                <label for="pago-transf">Transf.</label>
                                <input type="radio" name="pago" id="pago-efectivo" value="Efectivo">
                                <label for="pago-efectivo">Efectivo</label>
                            </div>
                        </div>
                    </div>
                    <!-- Orden de posici√≥n (editable s√≥lo en c√≥digo) -->
                    <div class="footer-compra-sticky">
                        <div class="total-final">
                            <span>Total Estimado:</span>
                            <span id="total-precio">$0</span>
                        </div>
                        <div style="display:flex; gap:8px; flex-direction:column;">
                            <button id="btn-agregar-carrito-modal" class="boton-pedir" onclick="handleCarritoToggle();" title="Agregar al carrito">
                                <i class="ph ph-shopping-cart"></i> Agregar al carrito
                            </button>
                            <button id="btn-whatsapp-modal" class="boton-whatsapp-modal" onclick="enviarWhatsapp();">
                                <i class="ph ph-whatsapp-logo" style="margin-right:8px;"></i><span>Comprar ya</span>
                            </button>
                        </div>
                    </div>
                    <div id="advertencia-sobre-pedido-modal" class="advertencia-pago" style="display:none; background: rgba(255, 193, 7, 0.15); border: 1px solid rgba(255, 193, 7, 0.4); color: #ffc107; padding: 12px; border-radius: 8px; margin-top: 10px;">
                        <i class="ph ph-warning" style="margin-right: 6px;"></i>
                        <strong>‚ö†Ô∏è Sobre Pedido:</strong> Requiere anticipo del 50%. El pedido estar√° listo en aproximadamente 7 d√≠as.
                    </div>
                    <div class="advertencia-pago">Todo precio ser√° verificado por producto</div>
                </div>
                <div class="seccion-recomendados">
                    <div class="header-recomendados">
                        <h3>Tambi√©n te podr√≠a interesar</h3>
                        <div class="controles-scroll">
                            <button onclick="scrollRecomendados(-1)"><i class="ph ph-caret-left"></i></button>
                            <button onclick="scrollRecomendados(1)"><i class="ph ph-caret-right"></i></button>
                        </div>
                    </div>
                    <div class="grid-recomendados-wrapper">
                        <div class="grid-recomendados" id="grid-recomendados"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating WhatsApp Button -->
    <button id="whatsapp-floating" class="btn-whatsapp" onclick="toggleFloatingCart()" aria-label="Abrir carrito">
        <i class="ph ph-whatsapp-logo"></i>
        <span id="whatsapp-badge" class="whatsapp-badge">0</span>
    </button>

    <!-- Floating cart panel -->
    <div id="floating-cart-panel" class="floating-cart-panel" style="display:none;" aria-hidden="true">
        <button class="cerrar-flotante cerrar-flotante-fab" onclick="closeFloatingCart()" aria-label="Cerrar carrito">
            <i class="ph ph-x"></i>
        </button>
        <div class="floating-cart-header">
            <strong>Tu Pedido</strong>
            <button class="cerrar-flotante" onclick="closeFloatingCart()"><i class="ph ph-x"></i></button>
        </div>
        <!-- compact floating cart header area (no inputs) -->
        <div class="floating-cart-subtitle">
            <div>Revisa tu pedido y confirma</div>
        </div>
        <div id="floating-cart-list" class="floating-cart-list"></div>
        <div id="sobre-pedido-advertencia" class="advertencia-sobre-pedido" style="display:none;">
            <i class="ph ph-warning"></i>
            <div>
                <strong>‚ö†Ô∏è Importante:</strong> Los productos sobre pedido requieren un anticipo del 50% para procesar tu orden. El pedido estar√° listo aproximadamente 7 d√≠as despu√©s del pago.
            </div>
        </div>
        <div class="floating-cart-footer">
            <div class="floating-total">Total: <span id="floating-total">$0</span></div>
            <div class="floating-actions">
                <button id="btn-hacer-pedido" class="btn-primary" onclick="sendWholeOrderWhatsApp()">
                    <i class="ph ph-whatsapp-logo" style="margin-right:6px; font-size:1.1rem;"></i>
                    Pedir Ahora
                </button>
            </div>
        </div>
    </div>

    <!-- Bot√≥n flotante para hacer pedido desde el carrito -->
    <button id="btn-order-now-floating" class="btn-order-now" onclick="sendWholeOrderWhatsApp()" style="display:none;">Comprar ya</button>

    <footer>
        <p class="footer-logo">VP</p>
        <p class="copyright">¬© 2025 Vip Acayucan - Todos los derechos reservados</p>
    </footer>

    <!-- =================================================================
         L√ìGICA JAVASCRIPT
         ================================================================= -->
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <script>
        // Inicializar AOS con seguridad
        try {
            AOS.init({ once: true, offset: 50, duration: 800 });
        } catch (e) {
            console.log("Error iniciando animaciones, modo seguro activado");
        }

        const formatearDinero = (cantidad) => {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(cantidad);
        };

        // TICKER: mensajes y tiempo de rotaci√≥n (necesarios para iniciarTicker)
        const MENSAJES_TICKER = [
            'Ya inauguramos üéâ',
            'Promociones por inauguraci√≥n üéä',
            '‚ö° Aprovecha ya compra ahora ‚ö°',
            'Pedidos al 924 127 7313 üìû',
            ' Vip Acayucan üëë'
        ];
        const TIEMPO_ROTACION = 4000; // ms

        // ============================================================
        // AJUSTES R√ÅPIDOS (EDITA AQU√ç PARA ACTIVAR/DESACTIVAR)
        // - mostrarCTAPublicidad: bot√≥n "Click aqu√≠" en la tarjeta de publicidad
        // - pausarVideosFueraDeVista: usa IntersectionObserver para pausar el video si no se ve
        // - mostrarBackToTop: muestra el bot√≥n flotante para volver arriba
        // ============================================================
        const AJUSTES_RAPIDOS = {
            mostrarCTAPublicidad: true,
            pausarVideosFueraDeVista: true,
            mostrarBackToTop: true
        };

        // =================================================================
        // === ZONAS SEGUROS PARA EDITAR ===
        // - CONFIG_SECCIONES: tarjetas de portada (t√≠tulos, subt√≠tulos, im√°genes)
        // - MENSAJES_TICKER: l√≠neas que aparecen en el ticker superior
        // - listaProductos: cat√°logo de productos (nombre, precio, imagen, variantes)
        // - Tel√©fono WhatsApp: modificar la variable `telefono` dentro de
        //   `enviarWhatsapp()` y `sendWholeOrderWhatsApp()` cuando sea necesario.
        // =================================================================
        const CONFIG_SECCIONES = [
            {
                id: 'ofertas',
                titulo: '',
                subtitulo: '',
                img: 'image/oferta.png',
                disponible: true,
                visible: true,
                esOferta: true,
                orden: 1
            },
            {
                id: 'perfumes',
                titulo: 'Perfumes',
                subtitulo: 'Fragancias',
                img: 'image/portada_perfumes.png',
                disponible: true,
                visible: true,
                orden: 5
            },
            {
                id: 'ropa',
                titulo: 'Ropa',
                subtitulo: 'Moda y Flow',
                img: 'https://images.unsplash.com/photo-1523381210434-271e8be1f52b?q=80&w=800&auto=format&fit=crop',
                disponible: false,
                visible: true,
                orden: 6
            },
            {
                id: 'sobrepedido',
                titulo: 'Sobre pedido',
                subtitulo: 'Piezas exclusivas por encargo',
                img: 'image/sobre_pedido.png',
                disponible: true,
                visible: true,
                orden: 4
            },
            {
                id: 'relojes',
                titulo: 'Relojes',
                subtitulo: 'Premium & Cl√°sicos',
                img: 'https://images.unsplash.com/photo-1524592094714-0f0654e20314?q=80&w=800&auto=format&fit=crop',
                disponible: false,
                visible: true,
                orden: 7
            },
            {
                id: 'vapes',
                titulo: 'Vapes',
                subtitulo: 'De las mejores marcas',
                img: 'https://images.unsplash.com/photo-1563821010-859a53855a84?q=80&w=800&auto=format&fit=crop',
                disponible: true,
                visible: true,
                orden: 3
            },
            {
                id: 'waxx',
                titulo: 'Waxx',
                subtitulo: 'Humo de calidad ',
                img: 'image/portada_wax.jpg',
                disponible: true,
                visible: true,
                orden: 2
            },
            {
                id: 'otros',
                titulo: 'Otros Productos',
                subtitulo: 'Echa un vistazo',
                img: 'https://images.unsplash.com/photo-1611921356619-fa89552f9549?q=80&w=800&auto=format&fit=crop',
                disponible: true,
                visible: true,
                orden: 8
            },
            {
                id: 'publicidad',
                titulo: '',
                subtitulo: '',
                img: 'image/Anuncio1.mp4',
                disponible: true,
                esPublicidad: true,
                esVideo: true,
                link: 'https://www.instagram.com/acyn_vp/',
                visible: true,
                orden: 9
            }
        ];

        const SABORES_VAPES = [
            { nombre: "Sand√≠a Ice", disponible: true }, { nombre: "Menta Fresca", disponible: true },
            { nombre: "Uva Morada", disponible: true }, { nombre: "Mango Tropical", disponible: true },
            { nombre: "Blue Razz", disponible: false }, { nombre: "Fresa Kiwi", disponible: true }
        ];

        const listaProductos = [
            // --- PERFUMES (12 Items) ---
            { id: 1, categoria: 'perfumes', activo: true, orden: 1, nombre: "Versace Eros", modelo: "EDT 100ml", precio: 1800, precioOriginal: 2200, enPromocion: true, img: "https://images.unsplash.com/photo-1585218356057-dc0e8d3558bb?q=80&w=800" },
            { id: 2, categoria: 'perfumes', activo: true, orden: 2, nombre: "Sauvage Dior", modelo: "EDT 100ml", precio: 2500, precioOriginal: 2800, enPromocion: true, img: "https://images.unsplash.com/photo-1523293182086-7651a899d37f?q=80&w=800" },
            { id: 3, categoria: 'perfumes', activo: true, orden: 3, nombre: "One Million", modelo: "Parfum 100ml", precio: 1950, precioOriginal: 2100, enPromocion: true, img: "https://images.unsplash.com/photo-1594035910387-fea4779426e9?q=80&w=800" },
            { id: 4, categoria: 'perfumes', activo: true, orden: 4, nombre: "Bad Boy", modelo: "Carolina Herrera 100ml", precio: 2100, precioOriginal: 2700, enPromocion: true, img: "https://images.unsplash.com/photo-1616949755610-8c9bbc08f138?q=80&w=800" },
            { id: 5, categoria: 'perfumes', activo: true, orden: 5, nombre: "Nautica Voyage", modelo: "Eau de Toilette 100ml", precio: 600, precioOriginal: 800, enPromocion: true, img: "https://images.unsplash.com/photo-1588405748880-12d1d2a59f75?q=80&w=800" },
            { id: 6, categoria: 'perfumes', activo: true, orden: 6, nombre: "Club de Nuit", modelo: "Intense Man 105ml", precio: 1200, precioOriginal: 1500, enPromocion: true, img: "https://images.unsplash.com/photo-1592945403244-b3fbafd7f539?q=80&w=800" },
            { id: 7, categoria: 'perfumes', activo: true, orden: 7, nombre: "Le Male", modelo: "Jean Paul Gaultier", precio: 2300, precioOriginal: 2600, enPromocion: true, img: "https://images.unsplash.com/photo-1541643600914-78b084683601?q=80&w=800" },
            { id: 8, categoria: 'perfumes', activo: true, orden: 8, nombre: "Bleu de Chanel", modelo: "Chanel Paris 100ml", precio: 3100, precioOriginal: 3500, enPromocion: true, img: "https://images.unsplash.com/photo-1520031441872-265e4ff70366?q=80&w=800" },
            { id: 9, categoria: 'perfumes', activo: true, orden: 9, nombre: "Acqua di Gio", modelo: "Giorgio Armani 100ml", precio: 2200, precioOriginal: 2400, enPromocion: true, img: "https://images.unsplash.com/photo-1590736704728-f4730bb30770?q=80&w=800" },
            { id: 10, categoria: 'perfumes', activo: true, orden: 10, nombre: "Invictus", modelo: "Paco Rabanne 100ml", precio: 2000, precioOriginal: 2300, enPromocion: true, img: "https://images.unsplash.com/photo-1582211584512-d8b73004008e?q=80&w=800" },
            { id: 11, categoria: 'perfumes', activo: true, orden: 11, nombre: "Montblanc Explorer", modelo: "EDP 100ml", precio: 1400, precioOriginal: 1600, enPromocion: false, img: "https://images.unsplash.com/photo-1587017539504-67cfbddac569?q=80&w=800" },
            { id: 12, categoria: 'perfumes', activo: true, orden: 12, nombre: "212 VIP Black", modelo: "Carolina Herrera", precio: 2200, precioOriginal: 2500, enPromocion: true, img: "https://images.unsplash.com/photo-1587017539504-67cfbddac569?q=80&w=800" },

            // --- ROPA (12 Items) ---
            { id: 101, categoria: 'ropa', activo: true, orden: 1, nombre: "Hoodie VP Black", modelo: "Talla L", precio: 650, precioOriginal: 800, enPromocion: true, img: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?q=80&w=800" },
            { id: 102, categoria: 'ropa', activo: true, orden: 2, nombre: "Playera Street", modelo: "Blanca", precio: 350, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?q=80&w=800" },
            { id: 103, categoria: 'ropa', activo: true, orden: 3, nombre: "Joggers Cargo", modelo: "Negro T√°ctico", precio: 550, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1552160753-117159d74190?q=80&w=800" },
            { id: 104, categoria: 'ropa', activo: true, orden: 4, nombre: "Sudadera Gris", modelo: "B√°sica", precio: 600, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1578587018452-892bacefd3f2?q=80&w=800" },
            { id: 105, categoria: 'ropa', activo: true, orden: 5, nombre: "Short Deportivo", modelo: "Secado R√°pido", precio: 280, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1591195853828-11db59a44f6b?q=80&w=800" },
            { id: 106, categoria: 'ropa', activo: true, orden: 6, nombre: "Jersey Baseball", modelo: "VP Team", precio: 450, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1576969526810-b41e6e944742?q=80&w=800" },
            { id: 107, categoria: 'ropa', activo: true, orden: 7, nombre: "Playera Long", modelo: "Manga Larga", precio: 400, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1618354691373-d851c5c3a990?q=80&w=800" },
            { id: 108, categoria: 'ropa', activo: true, orden: 8, nombre: "Windbreaker", modelo: "Rompevientos", precio: 800, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1591047139829-d91aecb6caea?q=80&w=800" },
            { id: 109, categoria: 'ropa', activo: true, orden: 9, nombre: "Pantal√≥n Chino", modelo: "Beige", precio: 500, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1591047139829-d91aecb6caea?q=80&w=800" },
            { id: 110, categoria: 'ropa', activo: true, orden: 10, nombre: "Chaleco Puffer", modelo: "Negro", precio: 750, precioOriginal: 900, enPromocion: true, img: "https://images.unsplash.com/photo-1591047139829-d91aecb6caea?q=80&w=800" },
            { id: 111, categoria: 'ropa', activo: true, orden: 11, nombre: "Jeans Rotos", modelo: "Skinny", precio: 600, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1582552938357-32b906df40cb?q=80&w=800" },
            { id: 112, categoria: 'ropa', activo: true, orden: 12, nombre: "Camisa Cuadros", modelo: "Le√±ador", precio: 450, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1589310243389-96a5483213a8?q=80&w=800" },

            // --- VAPES (12 Items) ---
            { id: 201, categoria: 'vapes', activo: true, orden: 1, nombre: "Waka 6000", modelo: "Recargable", precio: 400, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1563821010-859a53855a84?q=80&w=800", sabores: SABORES_VAPES },
            { id: 202, categoria: 'vapes', activo: true, orden: 2, nombre: "ElfBar BC5000", modelo: "5000 Puffs", precio: 350, precioOriginal: 450, enPromocion: true, img: "https://images.unsplash.com/photo-1534119339343-73db60d4b64a?q=80&w=800", sabores: SABORES_VAPES },
            { id: 203, categoria: 'vapes', activo: true, orden: 3, nombre: "Lost Mary", modelo: "OS5000", precio: 380, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1574920807753-333e248b9432?q=80&w=800", sabores: SABORES_VAPES },
            { id: 204, categoria: 'vapes', activo: true, orden: 4, nombre: "Maskking High", modelo: "Pro Max", precio: 250, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1579222530327-14227928d1d0?q=80&w=800", sabores: SABORES_VAPES },
            { id: 205, categoria: 'vapes', activo: true, orden: 5, nombre: "Geek Bar", modelo: "Pulse 15k", precio: 420, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1604170422479-7df97b7b9e07?q=80&w=800", sabores: SABORES_VAPES },
            { id: 206, categoria: 'vapes', activo: true, orden: 6, nombre: "Oxbar", modelo: "Magic Maze", precio: 410, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1565551352631-b0e9db63a436?q=80&w=800", sabores: SABORES_VAPES },
            { id: 207, categoria: 'vapes', activo: true, orden: 7, nombre: "Pluto", modelo: "7000 Puffs", precio: 300, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1598960243431-7b052e07971f?q=80&w=800", sabores: SABORES_VAPES },
            { id: 208, categoria: 'vapes', activo: true, orden: 8, nombre: "Vape Soul", modelo: "Smile 2", precio: 280, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1620215707769-633096245037?q=80&w=800", sabores: SABORES_VAPES },
            { id: 209, categoria: 'vapes', activo: true, orden: 9, nombre: "Ignite", modelo: "V50", precio: 450, precioOriginal: 500, enPromocion: true, img: "https://images.unsplash.com/photo-1622699292376-788b22e430f7?q=80&w=800", sabores: SABORES_VAPES },
            { id: 210, categoria: 'vapes', activo: true, orden: 10, nombre: "RandM Tornado", modelo: "9000 Puffs", precio: 390, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1628532729969-90cb89c74826?q=80&w=800", sabores: SABORES_VAPES },
            { id: 211, categoria: 'vapes', activo: true, orden: 11, nombre: "Juul 2", modelo: "Kit", precio: 600, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1563821010-859a53855a84?q=80&w=800", sabores: SABORES_VAPES },
            { id: 212, categoria: 'vapes', activo: true, orden: 12, nombre: "Stlth", modelo: "Device", precio: 300, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1563821010-859a53855a84?q=80&w=800", sabores: SABORES_VAPES },

            // --- SOBRE PEDIDO (12 Items) ---
            { id: 501, categoria: 'sobrepedido', activo: true, orden: 1, nombre: "NY Yankees", modelo: "Negra B√°sica", precio: 600, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1588850561407-ed78c282e89b?q=80&w=800" },
            { id: 502, categoria: 'sobrepedido', activo: true, orden: 2, nombre: "LA Dodgers", modelo: "Azul Real", precio: 600, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1622445275463-afa2ab738c34?q=80&w=800" },
            { id: 503, categoria: 'sobrepedido', activo: true, orden: 3, nombre: "Red Sox", modelo: "Azul Marino", precio: 600, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1556306535-0f09a537f0a3?q=80&w=800" },
            { id: 504, categoria: 'sobrepedido', activo: true, orden: 4, nombre: "White Sox", modelo: "Negra/Blanca", precio: 600, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1582748153413-0975193992b8?q=80&w=800" },
            { id: 505, categoria: 'sobrepedido', activo: true, orden: 5, nombre: "Bulls NBA", modelo: "Roja Snapback", precio: 550, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1589831377283-33cb1cc6bd5d?q=80&w=800" },
            { id: 506, categoria: 'sobrepedido', activo: true, orden: 6, nombre: "Raiders NFL", modelo: "Negra Cl√°sica", precio: 600, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1575428652377-a2d80e2277fc?q=80&w=800" },
            { id: 507, categoria: 'sobrepedido', activo: true, orden: 7, nombre: "Dad Hat Nike", modelo: "Swoosh Beige", precio: 450, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1533055640609-24b498dfd74c?q=80&w=800" },
            { id: 508, categoria: 'sobrepedido', activo: true, orden: 8, nombre: "Adidas Trefoil", modelo: "Trucker Azul", precio: 400, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1582239474776-3f6285266846?q=80&w=800" },
            { id: 509, categoria: 'sobrepedido', activo: true, orden: 9, nombre: "Goorin Bros", modelo: "Lion", precio: 800, precioOriginal: 950, enPromocion: true, img: "https://images.unsplash.com/photo-1618354691792-d1d42acfd860?q=80&w=800" },
            { id: 510, categoria: 'sobrepedido', activo: true, orden: 10, nombre: "Goorin Bros", modelo: "Black Sheep", precio: 800, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1521369909029-2afed882baee?q=80&w=800" },
            { id: 511, categoria: 'sobrepedido', activo: true, orden: 11, nombre: "47 Brand", modelo: "Clean Up NY", precio: 550, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1582748153413-0975193992b8?q=80&w=800" },
            { id: 512, categoria: 'sobrepedido', activo: true, orden: 12, nombre: "Bucket Hat", modelo: "Pescador Reversible", precio: 250, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1565333552077-949d03e2e13e?q=80&w=800" },

            // --- RELOJES (12 Items) ---
            { id: 601, categoria: 'relojes', activo: true, orden: 1, nombre: "Casio Vintage", modelo: "Dorado Digital", precio: 1200, precioOriginal: 1500, enPromocion: true, img: "https://images.unsplash.com/photo-1522312346375-d1a52e2b99b3?q=80&w=800" },
            { id: 602, categoria: 'relojes', activo: true, orden: 2, nombre: "G-Shock", modelo: "GA-2100 Negro", precio: 2500, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1524592094714-0f0654e20314?q=80&w=800" },
            { id: 603, categoria: 'relojes', activo: true, orden: 3, nombre: "Rolex Clone", modelo: "Submariner (Replica)", precio: 3500, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1587836374828-4dbafa94cf0e?q=80&w=800" },
            { id: 604, categoria: 'relojes', activo: true, orden: 4, nombre: "Apple Watch", modelo: "Series 7 (Refurb)", precio: 4500, precioOriginal: 5500, enPromocion: true, img: "https://images.unsplash.com/photo-1546868871-7041f2a55e12?q=80&w=800" },
            { id: 605, categoria: 'relojes', activo: true, orden: 5, nombre: "Invicta", modelo: "Pro Diver", precio: 2800, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1539874754764-5a96559165b0?q=80&w=800" },
            { id: 606, categoria: 'relojes', activo: true, orden: 6, nombre: "Fossil", modelo: "Gen 6", precio: 3200, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?q=80&w=800" },
            { id: 607, categoria: 'relojes', activo: true, orden: 7, nombre: "Casio F91W", modelo: "Cl√°sico Negro", precio: 350, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1522312346375-d1a52e2b99b3?q=80&w=800" },
            { id: 608, categoria: 'relojes', activo: true, orden: 8, nombre: "Seiko 5", modelo: "Autom√°tico", precio: 4500, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1619134778706-c89b275218d6?q=80&w=800" },
            { id: 609, categoria: 'relojes', activo: true, orden: 9, nombre: "Diesel", modelo: "Mr. Daddy", precio: 5000, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1533139502658-0198f920d3e8?q=80&w=800" },
            { id: 610, categoria: 'relojes', activo: true, orden: 10, nombre: "Michael Kors", modelo: "Bradshaw Gold", precio: 3800, precioOriginal: 4500, enPromocion: true, img: "https://images.unsplash.com/photo-1542496658-e33a6d0d50f6?q=80&w=800" },
            { id: 611, categoria: 'relojes', activo: true, orden: 11, nombre: "Tommy Hilfiger", modelo: "Decker", precio: 2900, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1600003014608-c2ccc1570a65?q=80&w=800" },
            { id: 612, categoria: 'relojes', activo: true, orden: 12, nombre: "Huawei Band", modelo: "Smart Band 7", precio: 900, precioOriginal: 1200, enPromocion: true, img: "https://images.unsplash.com/photo-1557935728-e6d1eaed1560?q=80&w=800" },
            
            // --- WAXX (12 Items) ---
            { id: 301, categoria: 'waxx', activo: true, orden: 1, nombre: "Cartucho HHC", modelo: "1g - Sativa", precio: 700, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1615211913175-1035515c1386?q=80&w=800" },
            { id: 302, categoria: 'waxx', activo: true, orden: 2, nombre: "Gomitas HHC", modelo: "Frutos Rojos", precio: 500, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1581795795323-65907b5de431?q=80&w=800" },
            { id: 303, categoria: 'waxx', activo: true, orden: 3, nombre: "Pluma Wax", modelo: "Bater√≠a Variable", precio: 350, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1558234440-62283a049444?q=80&w=800" },
            { id: 304, categoria: 'waxx', activo: true, orden: 4, nombre: "Live Resin", modelo: "Disposable 2g", precio: 1200, precioOriginal: 1400, enPromocion: true, img: "https://images.unsplash.com/photo-1615211913175-1035515c1386?q=80&w=800" },
            { id: 305, categoria: 'waxx', activo: true, orden: 5, nombre: "Cartucho Delta 8", modelo: "Indica 1g", precio: 650, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1581795795323-65907b5de431?q=80&w=800" },
            { id: 306, categoria: 'waxx', activo: true, orden: 6, nombre: "Bater√≠a 510", modelo: "Rosca Universal", precio: 200, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1558234440-62283a049444?q=80&w=800" },
            { id: 307, categoria: 'waxx', activo: true, orden: 7, nombre: "Dab Rig Mini", modelo: "Cristal Grueso", precio: 900, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1615211913175-1035515c1386?q=80&w=800" },
            { id: 308, categoria: 'waxx', activo: true, orden: 8, nombre: "Contenedor Silicona", modelo: "Antiadhrente", precio: 100, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1581795795323-65907b5de431?q=80&w=800" },
            { id: 309, categoria: 'waxx', activo: true, orden: 9, nombre: "Dab Tool Kit", modelo: "Acero Inoxidable", precio: 300, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1558234440-62283a049444?q=80&w=800" },
            { id: 310, categoria: 'waxx', activo: true, orden: 10, nombre: "Cartucho THC-P", modelo: "Potencia Alta", precio: 800, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1615211913175-1035515c1386?q=80&w=800" },
            { id: 311, categoria: 'waxx', activo: true, orden: 11, nombre: "Pre-roll Infundido", modelo: "Pack de 3", precio: 450, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1581795795323-65907b5de431?q=80&w=800" },
            { id: 312, categoria: 'waxx', activo: true, orden: 12, nombre: "Bong Vidrio", modelo: "Borosilicato 10in", precio: 1500, precioOriginal: 1800, enPromocion: true, img: "https://images.unsplash.com/photo-1558234440-62283a049444?q=80&w=800" },

            // --- OTROS (12 Items) ---
            { id: 401, categoria: 'otros', activo: true, orden: 1, nombre: "Cangurera VP", modelo: "Negra Logo", precio: 250, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1611921356619-fa89552f9549?q=80&w=800" },
            { id: 402, categoria: 'otros', activo: true, orden: 2, nombre: "Cartera Piel", modelo: "Minimalista", precio: 300, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1627123424574-18bd03606e42?q=80&w=800" },
            { id: 403, categoria: 'otros', activo: true, orden: 3, nombre: "Lentes Sol", modelo: "Aviador Negro", precio: 200, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1511499767150-a48a237f0083?q=80&w=800" },
            { id: 404, categoria: 'otros', activo: true, orden: 4, nombre: "Mochila T√°ctica", modelo: "Negra Militar", precio: 800, precioOriginal: 950, enPromocion: true, img: "https://images.unsplash.com/photo-1553062407-98eeb64c6a62?q=80&w=800" },
            { id: 405, categoria: 'otros', activo: true, orden: 5, nombre: "Cadena Cubana", modelo: "Chapa Oro 18k", precio: 600, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1599643478518-17488fbbcd75?q=80&w=800" },
            { id: 406, categoria: 'otros', activo: true, orden: 6, nombre: "Anillo Signet", modelo: "Acero Inoxidable", precio: 250, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1598532163257-ae3c6b2524b6?q=80&w=800" },
            { id: 407, categoria: 'otros', activo: true, orden: 7, nombre: "Calcetines VP", modelo: "Pack de 3", precio: 150, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1586350977771-b3b0abd50c82?q=80&w=800" },
            { id: 408, categoria: 'otros', activo: true, orden: 8, nombre: "Llavero Mosquet√≥n", modelo: "Urbano", precio: 120, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1627123424574-18bd03606e42?q=80&w=800" },
            { id: 409, categoria: 'otros', activo: true, orden: 9, nombre: "Cintur√≥n Cuero", modelo: "Hebilla Autom√°tica", precio: 400, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1553062407-98eeb64c6a62?q=80&w=800" },
            { id: 410, categoria: 'otros', activo: true, orden: 10, nombre: "Pulsera Volc√°nica", modelo: "Piedra Natural", precio: 180, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1599643478518-17488fbbcd75?q=80&w=800" },
            { id: 411, categoria: 'otros', activo: true, orden: 11, nombre: "Case iPhone", modelo: "Logo VP", precio: 250, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1541807084-5c52b6b3bd99?q=80&w=800" },
            { id: 412, categoria: 'otros', activo: true, orden: 12, nombre: "Termo Acero", modelo: "Negro Mate", precio: 350, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1602143407151-11115cdbf69c?q=80&w=800" }
        ];

        let productoActual = null;
        let carrito = JSON.parse(localStorage.getItem('vp_carrito')) || [];
        let mensajeIndex = 0;
        let tickerInterval;

        // Cargar carrito del localStorage y renderizar
        function cargarCarritoDelStorage() {
            const stored = localStorage.getItem('vp_carrito');
            if (stored) {
                try {
                    carrito = JSON.parse(stored);
                    actualizarBadgeCarrito();
                    renderFloatingCart();
                } catch (e) {
                    console.log('Error cargando carrito:', e);
                }
            }
        }

        // Si la vista del carrito est√° abierta (seccion-grid), forzar re-render
        function syncCarritoViewIfOpen() {
            try {
                const gridEl = document.getElementById('seccion-grid');
                if (gridEl && gridEl.style.display === 'block') {
                    // Solo actualizar si ya estamos en la vista del carrito
                    const contenedor = document.getElementById('grid-productos');
                    if (contenedor && contenedor.querySelector('.carrito-header')) {
                        abrirCarrito();
                    }
                }
            } catch (e) {
                console.warn('syncCarritoViewIfOpen error', e);
            }
        }

        function iniciarTicker() {
            mostrarMensajeTicker(mensajeIndex);
            tickerInterval = setInterval(() => { cambiarMensaje(1); }, TIEMPO_ROTACION);
        }
        function mostrarMensajeTicker(index) {
            const display = document.getElementById('ticker-display');
            display.style.opacity = 0;
            display.style.transform = "translateY(5px)";
            setTimeout(() => {
                const msg = (Array.isArray(MENSAJES_TICKER) && MENSAJES_TICKER.length) ? MENSAJES_TICKER[index] || MENSAJES_TICKER[0] : '';
                display.innerText = msg;
                display.style.opacity = 1;
                display.style.transform = "translateY(0)";
            }, 300);
        }
        function cambiarMensaje(dir) {
            clearInterval(tickerInterval);
            tickerInterval = setInterval(() => { cambiarMensaje(1); }, TIEMPO_ROTACION);
            mensajeIndex += dir;
            if (mensajeIndex >= MENSAJES_TICKER.length) mensajeIndex = 0;
            if (mensajeIndex < 0) mensajeIndex = MENSAJES_TICKER.length - 1;
            mostrarMensajeTicker(mensajeIndex);
        }

        function mostrarToast(mensaje) {
            const toast = document.getElementById('toast-notification');
            const msg = document.getElementById('toast-message');
            msg.innerText = mensaje;
            // Asegurar que el estilo inline no impida que la clase muestre el toast
            toast.style.display = '';
            toast.className = "toast show";
            // Ocultar despu√©s de 3s y limpiar display inline
            setTimeout(() => { 
                toast.className = toast.className.replace("show", ""); 
                // Espera la animaci√≥n y luego oculta por completo
                setTimeout(() => { toast.style.display = 'none'; }, 250);
            }, 3000);
        }

        // Muestra una confirmaci√≥n visual destacada al agregar producto
        let _successTimeout = null;
        function mostrarConfirmacionAgregado(mensaje = 'Agregado exitosamente') {
            try {
                const box = document.getElementById('success-alert');
                const txt = document.getElementById('success-text');
                if (!box || !txt) return;
                txt.innerText = mensaje;
                box.classList.remove('show');
                // Force reflow to restart animation
                void box.offsetWidth;
                box.classList.add('show');
                box.setAttribute('aria-hidden','false');
                // Limpiar timeout anterior
                if (_successTimeout) clearTimeout(_successTimeout);
                _successTimeout = setTimeout(() => {
                    box.classList.remove('show');
                    box.setAttribute('aria-hidden','true');
                }, 2000);
            } catch (e) { console.warn('mostrarConfirmacionAgregado error', e); }
        }
        
        function mostrarAlertaModal(msg) {
             document.getElementById('alert-title').innerText = "Atenci√≥n";
             document.getElementById('alert-message').innerText = msg;
             document.getElementById('custom-alert').style.display = 'flex';
        }
        
        function cerrarAlerta() {
             document.getElementById('custom-alert').style.display = 'none';
        }

        function irArriba() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
        
        window.onscroll = function() {
            const btn = document.getElementById('btn-back-to-top');
            if (!AJUSTES_RAPIDOS.mostrarBackToTop) {
                if (btn) btn.style.display = 'none';
                return;
            }
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                btn.style.display = "flex";
            } else {
                btn.style.display = "none";
            }
        };

        function actualizarBadgeCarrito() {
            const badge = document.getElementById('carrito-count');
            const totalQty = carrito.reduce((sum, it) => sum + (parseInt(it.cantidad, 10) || 0), 0);
            badge.innerText = totalQty;
            badge.style.transform = "scale(1.3)";
            setTimeout(() => badge.style.transform = "scale(1)", 200);
            // actualizar badge flotante
            const waBadge = document.getElementById('whatsapp-badge');
            if (waBadge) waBadge.innerText = totalQty;
        }
        
        function guardarEnCarrito(mostrarConfirmacion = true) {
            if (!productoActual) return;
            
            let cantidad = parseInt(document.getElementById('cantidad-seleccionada').value);
            let variante = "Est√°ndar";
            let inputManual = document.getElementById('input-variante-manual');
            let valorChip = document.getElementById('variante-seleccionada-valor') ? document.getElementById('variante-seleccionada-valor').value : "";
            
            if (inputManual && inputManual.value) variante = inputManual.value;
            else if (valorChip) variante = valorChip;
            
            if (productoActual.sabores && productoActual.sabores.length > 0 && !valorChip) {
                mostrarAlertaModal("‚ö†Ô∏è Por favor selecciona un sabor o variante.");
                return;
            }

            // Buscar por producto + variante para permitir m√∫ltiples variantes como items separados
            const existeIndex = carrito.findIndex(item => item.id === productoActual.id && item.variante === variante);
            const botonAgregar = document.getElementById('btn-agregar-carrito-modal');

            if (existeIndex === -1) {
                carrito.push({
                    id: productoActual.id,
                    cantidad: cantidad || 1,
                    variante: variante,
                    nombre: productoActual.nombre,
                    precio: productoActual.precio,
                    img: productoActual.img
                });

                // Actualizar bot√≥n a "Quitar"
                botonAgregar.innerHTML = '<i class="ph ph-trash"></i> Quitar del Carrito';
                botonAgregar.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';

                if (mostrarConfirmacion) {
                    mostrarToast('¬°Agregado al carrito!');
                    // Desde modal: mostrar tambi√©n la confirmaci√≥n animada verde para que sea visible
                    mostrarConfirmacionAgregado('Agregado exitosamente');
                }

            } else {
                if (!mostrarConfirmacion) {
                    // Al quitar desde el modal, eliminamos todos los items del mismo producto
                    carrito = carrito.filter(item => item.id !== productoActual.id);
                    // Actualizar bot√≥n a "Agregar"
                    botonAgregar.innerHTML = '<i class="ph ph-shopping-cart"></i> Agregar al carrito';
                    botonAgregar.style.background = 'linear-gradient(135deg, var(--gold-primary), var(--gold-dark))';
                    mostrarToast('Eliminado del carrito');
                } else {
                    carrito[existeIndex].cantidad = cantidad || carrito[existeIndex].cantidad;
                    carrito[existeIndex].variante = variante;
                    mostrarToast('Carrito actualizado');
                }
            }
            localStorage.setItem('vp_carrito', JSON.stringify(carrito));
            actualizarBadgeCarrito();
            renderFloatingCart();
            // Mantener la vista del carrito sincronizada si est√° abierta
            syncCarritoViewIfOpen();
        }

        function handleCarritoToggle() {
            if (!productoActual) return;
            
            // Verificar si el producto ya est√° en el carrito
            const enCarrito = carrito.some(item => item.id === productoActual.id);
            
            if (enCarrito) {
                // Eliminar del carrito
                carrito = carrito.filter(item => item.id !== productoActual.id);
                localStorage.setItem('vp_carrito', JSON.stringify(carrito));
                actualizarBadgeCarrito();
                renderFloatingCart();
                syncCarritoViewIfOpen();
                
                mostrarToast('Eliminado del carrito');
                
                // Cerrar modal autom√°ticamente
                cerrarModal();
                
                // Si el carrito qued√≥ vac√≠o, recargar la p√°gina
                if (carrito.length === 0) {
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                    return;
                }
            } else {
                // Agregar al carrito (no cerrar modal para seguir viendo productos)
                guardarEnCarrito();
                mostrarToast('‚úì Agregado al carrito');
            }
        }

        // Funci√≥n para actualizar el bot√≥n del modal basado en el estado del carrito
        function actualizarBotonModal() {
            if (!productoActual) return;
            const botonAgregar = document.getElementById('btn-agregar-carrito-modal');
            if (!botonAgregar) return;
            
            const enCarrito = carrito.some(item => item.id === productoActual.id);
            
            if (enCarrito) {
                botonAgregar.innerHTML = '<i class="ph ph-trash"></i> Quitar del Carrito';
                botonAgregar.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            } else {
                botonAgregar.innerHTML = '<i class="ph ph-shopping-cart"></i> Agregar al carrito';
                botonAgregar.style.background = 'linear-gradient(135deg, var(--gold-primary), var(--gold-dark))';
            }
        }

        function abrirCarrito() {
            if(carrito.length === 0) {
                mostrarAlertaModal("Tu carrito est√° vac√≠o. ¬°Agrega productos!");
                return;
            }
            document.getElementById('seccion-categorias').style.display = 'none';
            document.getElementById('seccion-grid').style.display = 'block';
            
            // Mostrar bot√≥n flotante de hacer pedido
            const btnOrderNow = document.getElementById('btn-order-now-floating');
            if (btnOrderNow) {
                btnOrderNow.style.display = 'block';
            }
            
            const contenedor = document.getElementById('grid-productos');
            // CORRECCI√ìN: grid-column: 1 / -1para que el t√≠tulo ocupe todo el ancho
            contenedor.innerHTML = `<div class="carrito-header" style="grid-column: 1 / -1;">
                <h2 class=\"titulo-seccion-grid\">Carrito (${carrito.length})</h2>
            </div>`;
            
            carrito.forEach(item => {
                const tarjeta = document.createElement('div');
                tarjeta.className = 'tarjeta-producto';
                tarjeta.innerHTML = `
                    <div class="img-wrapper"><img src="${item.img}" alt="${item.nombre}" onerror="this.onerror=null;this.src='https://via.placeholder.com/400x300?text=Imagen'"></div>
                    <div class="info-card">
                        <h3>${item.nombre}</h3>
                        <p style="color:#aaa; font-size:0.8rem; margin-bottom:5px;">${item.variante}</p>
                        <div style="display:flex; align-items:center; gap:12px; margin-top:6px;">
                            <div style="color:#bbb; font-size:0.9rem;">Precio unitario: ${formatearDinero(item.precio)}</div>
                            <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
                                <button class="btn-cant" type="button" onclick="event.stopPropagation(); updateItemCantidad(${item.id}, '${encodeURIComponent(item.variante)}', -1)"><i class="ph ph-minus"></i></button>
                                <div style="min-width:28px; text-align:center; color:#fff; font-weight:700;">${item.cantidad}</div>
                                <button class="btn-cant" type="button" onclick="event.stopPropagation(); updateItemCantidad(${item.id}, '${encodeURIComponent(item.variante)}', 1)"><i class="ph ph-plus"></i></button>
                            </div>
                        </div>
                        <p class="precio-card" style="margin-top:8px;">Subtotal: ${formatearDinero(item.precio * item.cantidad)}</p>
                    </div>
                `;
                tarjeta.onclick = function() { abrirModal(item.id); };
                contenedor.appendChild(tarjeta);
            });
        }

        function filtrarBusqueda() {
            const input = document.getElementById('input-busqueda');
            const filtro = input.value.toLowerCase();
            const resultadosDiv = document.getElementById('resultados-busqueda');
            resultadosDiv.innerHTML = '';
            
            if (filtro.length < 1) { 
                resultadosDiv.style.display = 'none';
                return;
            }

            const coincidencias = listaProductos.filter(prod => 
                prod.activo && (prod.nombre.toLowerCase().includes(filtro) || prod.modelo.toLowerCase().includes(filtro))
            );

            if (coincidencias.length > 0) {
                resultadosDiv.style.display = 'block';
                coincidencias.forEach(prod => {
                    const item = document.createElement('div');
                    item.className = 'resultado-item';
                    let ofertaTxt = prod.enPromocion ? '<span class="tag-oferta-busqueda">¬°OFERTA!</span>' : '';
                        item.innerHTML = `<img src="${prod.img}" style="width:40px; height:40px; object-fit:cover; border-radius:5px; margin-right:10px;" onerror="this.onerror=null;this.src='https://via.placeholder.com/80?text=Imagen'"/><div><span class="nombre-busqueda">${prod.nombre}</span><span class="modelo-busqueda" style="display:block; font-size:0.7rem;">${prod.modelo}</span></div>${ofertaTxt}`;
                    item.onclick = function() {
                        abrirModal(prod.id);
                        input.value = '';
                        resultadosDiv.style.display = 'none';
                    };
                    resultadosDiv.appendChild(item);
                });
            } else {
                resultadosDiv.style.display = 'none';
            }
        }

        function verificarEnter(event) {
            if (event.key === "Enter") {
                const texto = document.getElementById('input-busqueda').value.toLowerCase();
                if (texto.trim() === "") return;
                
                const resultados = listaProductos.filter(prod => 
                    prod.activo && (prod.nombre.toLowerCase().includes(texto) || prod.modelo.toLowerCase().includes(texto))
                );

                document.getElementById('seccion-categorias').style.display = 'none';
                document.getElementById('seccion-grid').style.display = 'block';
                const contenedor = document.getElementById('grid-productos');
                contenedor.innerHTML = "";
                
                if(resultados.length === 0) {
                    contenedor.innerHTML = `<p style="text-align:center; width:100%; color:#888;">No se encontraron productos.</p>`;
                } else {
                    renderizarGrid(resultados, contenedor, false);
                }
                
                document.getElementById('resultados-busqueda').style.display = 'none';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        document.addEventListener('click', function(event) {
            const buscador = document.querySelector('.buscador-container');
            if (!buscador.contains(event.target)) {
                document.getElementById('resultados-busqueda').style.display = 'none';
            }
        });

        function renderizarMenuInicio() {
            const cont = document.getElementById('contenedor-categorias-dinamico');
            cont.innerHTML = '';
            // Render sections ordered by `orden` (si no existe, se sit√∫a al final)
            const seccionesOrdenadas = [...CONFIG_SECCIONES].sort((a,b) => (a.orden ?? 999) - (b.orden ?? 999));
            seccionesOrdenadas.forEach((seccion, index) => {
                if(!seccion.visible) return;
                const div = document.createElement('div');
                div.className = 'tarjeta-categoria';
                if(!seccion.disponible) div.classList.add('tarjeta-bloqueada');
                div.setAttribute('data-aos', 'fade-up');
                div.setAttribute('data-aos-delay', index * 100);
                
                div.onclick = seccion.esPublicidad ? 
                    () => window.open(seccion.link, '_blank') : 
                    () => { if(seccion.disponible) cargarCatalogo(seccion.id); else mostrarAlertaModal("Pr√≥ximamente disponible"); };
                
                let badge = seccion.esOferta ? `<div class="badge-cat-promo">OFERTAS</div>` : '';
                // order label intentionally hidden (order is configured in code only)
                let orderLabel = '';
                let media = '';
                let soundBtn = '';
                if (String(seccion.img || '').endsWith('.mp4')) {
                    const vidId = `vid-seccion-${seccion.id}`;
                    media = `<video id="${vidId}" src="${seccion.img}" muted playsinline preload="metadata" class="media-fondo media-video" style="width:100%; height:100%; object-fit:cover; display:block;"></video>`;
                } else {
                    media = `<img src="${seccion.img}" class="media-fondo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x320?text=Imagen'" style="width:100%; height:100%; object-fit:cover; display:block;">`;
                }
                const cta = (seccion.esPublicidad && AJUSTES_RAPIDOS.mostrarCTAPublicidad) ? `<button type="button" class="cta-publicidad" onclick="event.stopPropagation(); window.open('${seccion.link}','_blank');">Click aqu√≠</button>` : '';
                let contenido = seccion.esPublicidad ? '' : `<h2>${seccion.titulo}</h2><p>${seccion.subtitulo}</p><span class="btn-entrar">${seccion.disponible ? 'Ver Cat√°logo' : 'Proximamente...'}</span>`;
                // A√±adir etiqueta de orden y un bot√≥n peque√±o para editar el orden de la secci√≥n
                // CTA publicidad: quita la l√≠nea del bot√≥n si no lo quieres visible
                div.innerHTML = `<div class="brillo-hover"></div>${badge}${orderLabel}<div class="media-container">${media}${cta}</div><div class="contenido-cat">${contenido}</div>`;
                // Removed visual edit button (editing order is done directly in code)
                cont.appendChild(div);
            });
            
            // FIX CR√çTICO: Refrescar AOS despu√©s de crear los elementos para que se vean
            setTimeout(() => AOS.refresh(), 200);
        }

        function cargarCatalogo(filtro) {
            document.getElementById('seccion-categorias').style.display = 'none';
            document.getElementById('seccion-grid').style.display = 'block';
            
            // Ocultar bot√≥n flotante de hacer pedido
            const btnOrderNow = document.getElementById('btn-order-now-floating');
            if (btnOrderNow) btnOrderNow.style.display = 'none';
            
            setTimeout(() => AOS.refresh(), 100);
            const contenedor = document.getElementById('grid-productos');
            // CORRECCI√ìN: Asegurar que el t√≠tulo de categor√≠a ocupe todo el ancho
            contenedor.innerHTML = `<h2 style="width:100%; text-align:center; color:#D4AF37; margin-bottom:20px; font-size:1.5rem; grid-column: 1 / -1;">${filtro.toUpperCase()}</h2>`;
            
            let prods = [];
            if(filtro === 'ofertas') prods = listaProductos.filter(p => p.activo && p.enPromocion);
            else prods = listaProductos.filter(p => p.activo && p.categoria === filtro);
            
            // ORDENAMIENTO POR PROPIEDAD "orden"
            prods.sort((a,b) => a.orden - b.orden);
            
            renderizarGrid(prods, contenedor, false); // false para no borrar el t√≠tulo
            window.scrollTo(0,0);
        }

        function renderizarGrid(lista, contenedor, limpiar = true) {
            if (limpiar) contenedor.innerHTML = "";
            if (lista.length === 0) { contenedor.innerHTML += `<p style="width:100%; text-align:center; color:#888; margin-top:50px; grid-column: 1 / -1;">No hay productos disponibles.</p>`; return; }
            lista.forEach((prod, idx) => {
                const tarjeta = document.createElement('div');
                tarjeta.className = 'tarjeta-producto';
                tarjeta.setAttribute('data-aos', 'fade-up');
                tarjeta.setAttribute('data-aos-delay', idx * 50);
                tarjeta.onclick = () => abrirModal(prod.id);
                let etiq = prod.enPromocion ? `<div class="etiqueta-oferta">OFERTA</div>` : '';
                let prec = prod.enPromocion ? `<div class="bloque-precios"><span class="precio-tachado">${formatearDinero(prod.precioOriginal)}</span><span class="precio-card precio-rojo">${formatearDinero(prod.precio)}</span></div>` : `<div class="bloque-precios"><span class="precio-card">${formatearDinero(prod.precio)}</span></div>`;
                // Controles r√°pidos: si el producto no tiene variantes ofrecidas, mostrar controles +/- directamente
                let controlesRapidos = '';
                const varianteDef = (prod.modelo && prod.modelo.length>0) ? prod.modelo : 'Est√°ndar';
                const enCarritoItem = carrito.find(it => it.id === prod.id && it.variante === varianteDef);
                    if (!prod.sabores || prod.sabores.length === 0) {
                    if (enCarritoItem) {
                        controlesRapidos = `<div class="qty-card" onclick="event.stopPropagation();"><button type=\"button\" class=\"btn-cant\" onclick=\"event.stopPropagation(); updateItemCantidad(${prod.id}, '${encodeURIComponent(varianteDef)}', -1)\"><i class=\"ph ph-minus\"></i></button><div class=\"qty-number\">${enCarritoItem.cantidad}</div><button type=\"button\" class=\"btn-cant\" onclick=\"event.stopPropagation(); updateItemCantidad(${prod.id}, '${encodeURIComponent(varianteDef)}', 1)\"><i class=\"ph ph-plus\"></i></button></div>`;
                    } else {
                        controlesRapidos = `<button class=\"btn-agregar-card\" onclick=\"event.stopPropagation(); agregarAlCarritoRapido(${prod.id})\" title=\"Agregar\"><i class=\"ph ph-shopping-cart\"></i></button>`;
                    }
                } else {
                    // si tiene sabores, tambi√©n mostrar el carrito r√°pido (agrega la primera variante disponible)
                    controlesRapidos = `<button class=\"btn-agregar-card\" onclick=\"event.stopPropagation(); agregarAlCarritoRapido(${prod.id})\" title=\"Agregar\"><i class=\"ph ph-shopping-cart\"></i></button>`;
                }

                tarjeta.innerHTML = `<div class="img-wrapper">${etiq}<img src="${prod.img}" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/400x300?text=Imagen'"></div><div class="info-card"><h3>${prod.nombre}</h3>${prec}<div style="display:flex; gap:8px; justify-content:center; align-items:center; margin-top:10px;">${controlesRapidos}<span class="texto-ver-detalles">Ver Detalles</span></div></div>`;
                contenedor.appendChild(tarjeta);
            });
        }

        // Pedir directo desde tarjeta de producto: a√±ade al carrito y abre el panel/enlace
        function pedirProductoDirecto(idProducto) {
            const producto = listaProductos.find(p => p.id === idProducto);
            if (!producto) return;
            // Variante por defecto
            let variante = producto.modelo || 'Est√°ndar';
            if (producto.sabores && producto.sabores.length > 0) variante = producto.sabores[0].nombre;
            // Buscar item existente por id+variante
            const idx = carrito.findIndex(it => it.id === producto.id && it.variante === variante);
            if (idx === -1) {
                carrito.push({ id: producto.id, cantidad: 1, variante, nombre: producto.nombre, precio: producto.precio, img: producto.img });
            } else {
                carrito[idx].cantidad = Number(carrito[idx].cantidad) + 1;
            }
            localStorage.setItem('vp_carrito', JSON.stringify(carrito));
            actualizarBadgeCarrito();
            renderFloatingCart();
            // Mostrar toast peque√±o y discreto (no modal, as√≠ que evitar la alerta animada)
            mostrarToast('‚úì Agregado al carrito');
            syncCarritoViewIfOpen();
            openFloatingCart();
        }

        // Agregar al carrito desde tarjeta de producto
        function agregarAlCarritoRapido(idProducto) {
            const producto = listaProductos.find(p => p.id === idProducto);
            if (!producto) return;
            // Si el producto tiene variantes/sabores, tomar la primera variante disponible por defecto
            let variante = producto.modelo || 'Est√°ndar';
            if (producto.sabores && producto.sabores.length > 0) {
                const primera = producto.sabores.find(s => s.disponible !== false) || producto.sabores[0];
                if (primera && primera.nombre) variante = primera.nombre;
            }
            const idx = carrito.findIndex(it => it.id === producto.id && it.variante === variante);
            if (idx === -1) {
                carrito.push({ id: producto.id, cantidad: 1, variante, nombre: producto.nombre, precio: producto.precio, img: producto.img });
                localStorage.setItem('vp_carrito', JSON.stringify(carrito));
                actualizarBadgeCarrito();
                renderFloatingCart();
                // Desde tarjeta (sin modal): mostrar toast peque√±o y discreto
                mostrarToast('‚úì Agregado al carrito');
                const wb = document.getElementById('whatsapp-badge');
                if (wb) { wb.classList.add('pulse'); setTimeout(() => wb.classList.remove('pulse'), 900); }
                syncCarritoViewIfOpen();
            } else {
                carrito[idx].cantidad = Number(carrito[idx].cantidad) + 1;
                localStorage.setItem('vp_carrito', JSON.stringify(carrito));
                actualizarBadgeCarrito();
                renderFloatingCart();
                syncCarritoViewIfOpen();
                // Actualizaci√≥n: mostrar solo toast para no distraer
                mostrarToast('‚úì Cantidad actualizada');
            }
        }

        function irAlInicio() {
            document.getElementById('seccion-categorias').style.display = 'block';
            document.getElementById('seccion-grid').style.display = 'none';
            document.getElementById('input-busqueda').value = '';
            
            // Ocultar bot√≥n flotante de hacer pedido
            const btnOrderNow = document.getElementById('btn-order-now-floating');
            if (btnOrderNow) btnOrderNow.style.display = 'none';
            
            window.scrollTo(0,0);
        }

        // --- MODAL ---
        function abrirModal(idProducto) {
            productoActual = listaProductos.find(p => p.id === idProducto);
            if(!productoActual) return;

            document.getElementById('modal-img').src = productoActual.img;
            document.getElementById('modal-titulo-producto').innerText = productoActual.nombre;
            document.getElementById('modal-modelo-producto').innerText = productoActual.modelo;
            
            const contPrecio = document.getElementById('contenedor-precio-modal');
            contPrecio.innerHTML = productoActual.enPromocion ? 
                `<span class="precio-tachado-modal">${formatearDinero(productoActual.precioOriginal)}</span><span class="precio-modal precio-rojo">${formatearDinero(productoActual.precio)}</span>` : 
                `<span class="precio-modal">${formatearDinero(productoActual.precio)}</span>`;

            document.getElementById('cantidad-seleccionada').value = 1;
            document.getElementById('total-precio').innerText = formatearDinero(productoActual.precio);

            // Mostrar y cargar valor de orden editable
            const inputOrden = document.getElementById('input-orden-modal');
            if (inputOrden) {
                inputOrden.value = (productoActual.orden !== undefined) ? productoActual.orden : '';
                inputOrden.onchange = function() { actualizarOrdenProductoActual(Number(this.value)); };
            }

            // Variantes
            const contVariantes = document.getElementById('contenedor-variantes');
            contVariantes.innerHTML = '';
            if (document.getElementById('variante-seleccionada-valor')) document.getElementById('variante-seleccionada-valor').value = ""; 

            if (productoActual.sabores && productoActual.sabores.length > 0) {
                document.getElementById('titulo-variantes').innerText = "Selecciona Sabor:";
                const grid = document.createElement('div'); grid.className = 'grid-variantes';
                const hiddenInput = document.getElementById('variante-seleccionada-valor');

                productoActual.sabores.forEach(sabor => {
                    const btn = document.createElement('button');
                    btn.className = `chip-variante ${sabor.disponible ? '' : 'agotado'}`;
                    btn.innerText = sabor.nombre;
                    
                    // Marcar si ya estaba seleccionado en carrito
                    const itemEnCarrito = carrito.find(i => i.id === productoActual.id);
                    if(itemEnCarrito && itemEnCarrito.variante === sabor.nombre) {
                        btn.classList.add('activo');
                        hiddenInput.value = sabor.nombre;
                    }

                    if (sabor.disponible) {
                        btn.onclick = function() {
                            document.querySelectorAll('.chip-variante').forEach(b => b.classList.remove('activo'));
                            btn.classList.add('activo');
                            hiddenInput.value = sabor.nombre;
                        };
                    }
                    grid.appendChild(btn);
                });
                contVariantes.appendChild(grid);
            } else {
                document.getElementById('titulo-variantes').innerText = "Especificaci√≥n:";
                // Recuperar valor
                const itemEnCarrito = carrito.find(i => i.id === productoActual.id);
                let val = itemEnCarrito ? itemEnCarrito.variante : productoActual.modelo;
                contVariantes.innerHTML = `<input type="text" id="input-variante-manual" value="${val}" readonly class="input-modal-texto">`;
            }

            // Actualizar bot√≥n de agregar/quitar seg√∫n estado en carrito
            const enCarrito = carrito.some(item => item.id === productoActual.id);
            const botonAgregar = document.getElementById('btn-agregar-carrito-modal');
            
            if (enCarrito) {
                botonAgregar.innerHTML = '<i class="ph ph-trash"></i> Quitar del Carrito';
                botonAgregar.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            } else {
                botonAgregar.innerHTML = '<i class="ph ph-shopping-cart"></i> Agregar al carrito';
                botonAgregar.style.background = 'linear-gradient(135deg, var(--gold-primary), var(--gold-dark))';
            }

            // Detectar si el producto es de "sobrepedido" y actualizar bot√≥n de WhatsApp
            const esSobrePedido = productoActual.categoria === 'sobrepedido';
            const btnWhatsApp = document.getElementById('btn-whatsapp-modal');
            const advertenciaSobrePedido = document.getElementById('advertencia-sobre-pedido-modal');
            
            if (esSobrePedido) {
                btnWhatsApp.innerHTML = '<i class="ph ph-whatsapp-logo" style="margin-right:8px;"></i><span>Hacer Sobre Pedido</span>';
                btnWhatsApp.style.background = 'linear-gradient(135deg, #9ca3af, #6b7280)';
                advertenciaSobrePedido.style.display = 'block';
            } else {
                btnWhatsApp.innerHTML = '<i class="ph ph-whatsapp-logo" style="margin-right:8px;"></i><span>Comprar ya</span>';
                btnWhatsApp.style.background = 'linear-gradient(180deg, #2ac05f 0%, #25d366 60%)';
                advertenciaSobrePedido.style.display = 'none';
            }

            // Recomendados
            const recomendados = listaProductos.filter(p => p.categoria === productoActual.categoria && p.id !== productoActual.id).slice(0, 5);
            const gridRecom = document.getElementById('grid-recomendados');
            gridRecom.innerHTML = '';
            recomendados.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'card-recomendada';
                card.onclick = function() { window.scrollTo({ top: 0, behavior: 'smooth' }); abrirModal(rec.id); };
                card.innerHTML = `<img src="${rec.img}" onerror="this.onerror=null;this.src='https://via.placeholder.com/150?text=Imagen'"><div><p class="rec-nombre">${rec.nombre}</p><p class="rec-precio">${formatearDinero(rec.precio)}</p></div>`;
                gridRecom.appendChild(card);
            });
            // A√±adir flechas flotantes para scroll t√°ctil en recomendaciones
            const wrapper = document.querySelector('.grid-recomendados-wrapper');
            // Eliminar flechas previas si existen
            ['.recom-arrow-left','.recom-arrow-right'].forEach(s => { const e = wrapper.querySelector(s); if (e) e.remove(); });
            const left = document.createElement('button');
            left.className = 'recom-arrow recom-arrow-left';
            left.innerHTML = '<i class="ph ph-caret-left"></i>';
            left.onclick = () => gridRecom.scrollBy({ left: -220, behavior: 'smooth' });
            const right = document.createElement('button');
            right.className = 'recom-arrow recom-arrow-right';
            right.innerHTML = '<i class="ph ph-caret-right"></i>';
            right.onclick = () => gridRecom.scrollBy({ left: 220, behavior: 'smooth' });
            wrapper.appendChild(left); wrapper.appendChild(right);

            const modalEl = document.getElementById('modal-pedido');
            modalEl.style.display = 'flex';
            document.body.classList.add('modal-open');
            // ensure modal content is scrolled to top and focused so user sees full product
            setTimeout(() => {
                const modalBody = modalEl.querySelector('.modal-body');
                if (modalBody) { modalBody.scrollTop = 0; }
                const closeBtn = modalEl.querySelector('.cerrar-modal');
                if (closeBtn) { closeBtn.focus(); }
                // scroll modal into view (useful on mobile)
                modalEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 60);
            // attach keyboard handlers for accessibility (ESC to close, focus trap)
            attachModalKeyHandlers();
        }

        function actualizarOrdenProductoActual(nuevoOrden) {
            if (!productoActual) return;
            if (isNaN(nuevoOrden)) { mostrarToast('Orden inv√°lido'); return; }
            productoActual.orden = Number(nuevoOrden);
            const idx = listaProductos.findIndex(p => p.id === productoActual.id);
            if (idx !== -1) listaProductos[idx].orden = productoActual.orden;
            // Reordenar vistas: men√∫ de inicio y grid actual si hay uno
            renderizarMenuInicio();
            if (document.getElementById('seccion-grid').style.display === 'block') {
                // Intentar deducir el filtro actual a partir del t√≠tulo en grid
                const tituloEl = document.querySelector('#grid-productos h2');
                    if (tituloEl) {
                    const filtro = tituloEl.innerText.toLowerCase();
                    cargarCatalogo(filtro, true);
                }
            }
            mostrarToast('Orden actualizado');
        }
        
        function scrollRecomendados(direction) {
            const container = document.getElementById('grid-recomendados');
            container.scrollBy({ left: direction * 200, behavior: 'smooth' });
        }

        // --- UTILS ---
        function cerrarModal() { document.getElementById('modal-pedido').style.display = 'none'; document.body.classList.remove('modal-open'); }

        // --- Accessibility: focus trap and ESC handler for modal ---
        let _lastFocusedBeforeModal = null;
        function attachModalKeyHandlers() {
            const modal = document.getElementById('modal-pedido');
            if (!modal) return;
            _lastFocusedBeforeModal = document.activeElement;
            function onKey(e) {
                if (e.key === 'Escape') {
                    cerrarModal();
                    removeHandlers();
                    return;
                }
                if (e.key === 'Tab') {
                    // simple focus trap
                    const focusable = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    if (!focusable.length) return;
                    const first = focusable[0];
                    const last = focusable[focusable.length -1];
                    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
                    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
                }
            }
            function removeHandlers() {
                document.removeEventListener('keydown', onKey);
            }
            document.addEventListener('keydown', onKey);
            // ensure on close we restore focus
            const origClose = window.cerrarModal;
            window.cerrarModal = function() {
                try { removeHandlers(); } catch(e){}
                if (_lastFocusedBeforeModal) try { _lastFocusedBeforeModal.focus(); } catch(e){}
                modal.style.display = 'none'; document.body.classList.remove('modal-open');
            };
        }
        
        function cambiarCantidad(cambio) {
            if(!productoActual) return;
            let input = document.getElementById('cantidad-seleccionada');
            let val = parseInt(input.value, 10) + cambio;
            if (isNaN(val)) val = 1;
            if (val >= 1 && val <= 10) {
                input.value = val;
                document.getElementById('total-precio').innerText = formatearDinero(val * productoActual.precio);
            }
        }
        
        function enviarWhatsapp() {
            if(!productoActual) return;
            // Modifica aqu√≠ al n√∫mero de WhatsApp (formato internacional sin '+')
            // Se ha configurado para enviar a: 52 + 9241277313
            const telefono = "529241277313";
            let variante = "Est√°ndar";
            
            const inputManualElem = document.getElementById('input-variante-manual');
            const hv = document.getElementById('variante-seleccionada-valor');
            if (inputManualElem) variante = inputManualElem.value;
            if (hv && hv.value) variante = hv.value;

            if (productoActual.sabores && (!hv || !hv.value)) { mostrarAlertaModal("‚ö†Ô∏è Elige un sabor"); return; }

            let cantidad = parseInt(document.getElementById('cantidad-seleccionada').value, 10) || 1;
            let pago = document.querySelector('input[name="pago"]:checked').value;
            let total = cantidad * productoActual.precio;
            let folio = Math.floor(1000 + Math.random() * 9000);

            guardarEnCarrito(true); // Guardar con notificaci√≥n

            // Detectar si es sobre pedido
            const esSobrePedido = productoActual.categoria === 'sobrepedido';
            
            let mensaje = `*PEDIDO #${folio}*\n\n`;
            
            if (esSobrePedido) {
                mensaje += `‚ö†Ô∏è *SOBRE PEDIDO:*\n`;
            }
            
            mensaje += `${productoActual.nombre} (${variante}) x${cantidad} - ${formatearDinero(total)}\n`;
            
            if (esSobrePedido) {
                const anticipo = total * 0.5;
                mensaje += `Anticipo 50%: ${formatearDinero(anticipo)}\n`;
                mensaje += `Entrega: 7 d√≠as aprox.\n`;
            }
            
            mensaje += `\nüí≥ Pago: ${pago}\n`;
            mensaje += `\n*Total: ${formatearDinero(total)}*`;
            
            const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;
            window.open(url, '_blank');
        }

        // Toggle favorite (heart) for current modal product
        function toggleFavorito() {
            if (!productoActual) return;
            const hv = document.getElementById('variante-seleccionada-valor');
            const inputManualElem = document.getElementById('input-variante-manual');
            const variante = (hv && hv.value) ? hv.value : (inputManualElem ? inputManualElem.value : productoActual.modelo);
            const icono = document.getElementById('icono-corazon-modal');
            const existeIndex = carrito.findIndex(item => item.id === productoActual.id && item.variante === variante);

            if (existeIndex === -1) {
                carrito.push({ id: productoActual.id, cantidad: 1, variante: variante, nombre: productoActual.nombre, precio: productoActual.precio, img: productoActual.img });
                icono.classList.remove('ph-shopping-cart-simple'); icono.classList.add('ph-shopping-cart'); icono.style.color = 'var(--gold-primary)';
            } else {
                carrito.splice(existeIndex, 1);
                icono.classList.remove('ph-shopping-cart'); icono.classList.add('ph-shopping-cart-simple'); icono.style.color = 'white';
            }
            localStorage.setItem('vp_carrito', JSON.stringify(carrito));
            actualizarBadgeCarrito();
            renderFloatingCart();
            // Mantener sincron√≠a si la vista de carrito est√° abierta
            syncCarritoViewIfOpen();
        }

        // Floating cart UI
        function renderFloatingCart() {
            const list = document.getElementById('floating-cart-list');
            if (!list) return;
            try {
                list.innerHTML = '';
                if (carrito.length === 0) {
                    list.innerHTML = '<p style="padding:12px; color:#bbb">No hay productos en el carrito.</p>';
                    document.getElementById('floating-total').innerText = formatearDinero(0);
                    const advertencia = document.getElementById('sobre-pedido-advertencia');
                    if (advertencia) advertencia.style.display = 'none';
                    return;
                }
                let total = 0;
                carrito.forEach(it => {
                    total += (parseInt(it.cantidad,10) || 0) * it.precio;
                    const row = document.createElement('div');
                    row.className = 'floating-cart-item';
                    row.innerHTML = `
                        <img src="${it.img}" onerror="this.onerror=null;this.src='https://via.placeholder.com/48?text=VP'" alt="${it.nombre}">
                        <div class="fci-info">
                            <div class="fci-name">${it.nombre}</div>
                            <div class="fci-variant">${it.variante}</div>
                            <div class="fci-controls">
                                <button class="btn-cant" type="button" onclick="event.stopPropagation(); updateItemCantidad(${it.id}, '${encodeURIComponent(it.variante)}', -1)"><i class="ph ph-minus"></i></button>
                                <span class="fci-qty">${it.cantidad}</span>
                                <button class="btn-cant" type="button" onclick="event.stopPropagation(); updateItemCantidad(${it.id}, '${encodeURIComponent(it.variante)}', 1)"><i class="ph ph-plus"></i></button>
                            </div>
                        </div>
                        <div class="fci-right">
                            <div class="fci-price">${formatearDinero(it.precio * it.cantidad)}</div>
                            <button class="btn-eliminar" onclick="event.stopPropagation(); removeItem(${it.id}, '${encodeURIComponent(it.variante)}')" title="Eliminar">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(row);
                });
                document.getElementById('floating-total').innerText = formatearDinero(total);
                
                // Detectar si hay productos de "sobrepedido" en el carrito
                const tieneSobrePedido = carrito.some(it => {
                    const prod = listaProductos.find(p => p.id === it.id);
                    return prod && prod.categoria === 'sobrepedido';
                });
                
                // Mostrar/ocultar la advertencia seg√∫n productos
                const advertencia = document.getElementById('sobre-pedido-advertencia');
                if (advertencia) {
                    if (tieneSobrePedido) {
                        advertencia.style.display = 'flex';
                    } else {
                        advertencia.style.display = 'none';
                    }
                }
                
                // If panel was open, ensure it's visible (in case a render caused it to be hidden)
                const panelEl = document.getElementById('floating-cart-panel');
                if (panelEl && panelEl.classList.contains('open')) {
                    panelEl.style.display = 'block';
                    panelEl.setAttribute('aria-hidden','false');
                }
            } catch (e) {
                console.error('Error renderizando carrito flotante:', e);
                list.innerHTML = '<p style="padding:12px; color:#f2b84b">Ha ocurrido un error mostrando el carrito. Intenta abrirlo de nuevo.</p>';
                document.getElementById('floating-total').innerText = formatearDinero(0);
            }
        }

        function updateItemCantidad(id, varianteEnc, cambio) {
            const variante = decodeURIComponent(varianteEnc);
            const idx = carrito.findIndex(it => it.id === id && it.variante === variante);
            if (idx === -1) return;
            let nueva = Number(carrito[idx].cantidad) + Number(cambio);
            
            // Si la cantidad llega a 0 o menos, eliminar el producto del carrito
            if (nueva <= 0) {
                carrito.splice(idx, 1);
                localStorage.setItem('vp_carrito', JSON.stringify(carrito));
                actualizarBadgeCarrito();
                renderFloatingCart();
                
                // Actualizar el bot√≥n del modal si est√° abierto con este producto
                if (productoActual && productoActual.id === id) {
                    actualizarBotonModal();
                }
                
                // Si el carrito qued√≥ vac√≠o, recargar la p√°gina para reiniciar todo
                if (carrito.length === 0) {
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                    return;
                }
                
                mostrarToast('Producto eliminado');
            } else {
                carrito[idx].cantidad = nueva;
                localStorage.setItem('vp_carrito', JSON.stringify(carrito));
                actualizarBadgeCarrito();
                renderFloatingCart();
            }
            
            // Actualizar la vista si el grid est√° visible: si el grid muestra el carrito, reabrirlo; si muestra otro filtro, re-renderizar ese filtro sin scroll
            if (document.getElementById('seccion-grid').style.display === 'block') {
                const cont = document.getElementById('grid-productos');
                if (cont && cont.querySelector('.carrito-header')) {
                    if (carrito.length > 0) {
                        abrirCarrito(true); // mantener sin scroll
                    }
                } else if (cont) {
                    const tituloEl = cont.querySelector('h2');
                    if (tituloEl) {
                        const filtro = tituloEl.innerText.toLowerCase();
                        cargarCatalogo(filtro, true);
                    }
                }
            }
        }

        function removeItem(id, varianteEnc) {
            const variante = decodeURIComponent(varianteEnc);
            carrito = carrito.filter(it => !(it.id === id && it.variante === variante));
            localStorage.setItem('vp_carrito', JSON.stringify(carrito));
            actualizarBadgeCarrito();
            renderFloatingCart();
            
            // Actualizar el bot√≥n del modal si est√° abierto con este producto
            if (productoActual && productoActual.id === id) {
                actualizarBotonModal();
            }
            
            // Actualizar la vista del carrito en grid si est√° abierta
            if (document.getElementById('seccion-grid').style.display === 'block') {
                const contenedor = document.getElementById('grid-productos');
                if (contenedor && contenedor.querySelector('.carrito-header')) {
                    if (carrito.length === 0) {
                        irAlInicio();
                    } else {
                        abrirCarrito();
                    }
                }
            }
        }

        function openFloatingCart() {
            const panel = document.getElementById('floating-cart-panel');
            if (!panel) return;
            renderFloatingCart();
            panel.style.display = 'block';
            panel.classList.add('open');
            panel.setAttribute('aria-hidden','false');
            // focus en el input nombre si existe
            setTimeout(() => {
                const nombre = document.getElementById('fc-name');
                if (nombre) nombre.focus();
            }, 150);
        }

        function toggleFloatingCart() {
            if(carrito.length === 0) {
                mostrarAlertaModal("Tu carrito est√° vac√≠o. ¬°Agrega productos!");
                return;
            }
            const panel = document.getElementById('floating-cart-panel');
            if (!panel) return;
            
            // Si est√° visible, cerrarlo
            if (panel.style.display === 'block' || panel.classList.contains('open')) {
                closeFloatingCart();
            } else {
                // Si est√° oculto, abrirlo
                openFloatingCart();
            }
        }

        function closeFloatingCart() {
            const panel = document.getElementById('floating-cart-panel');
            if (!panel) return;
            panel.classList.remove('open');
            panel.setAttribute('aria-hidden','true');
            // esperar la animaci√≥n y ocultar
            setTimeout(() => { panel.style.display = 'none'; }, 220);
            // devolver foco al bot√≥n whatsapp
            const btn = document.getElementById('whatsapp-floating');
            if (btn) btn.focus();
        }

        // Send whole cart as a single WhatsApp message (incluye nombre/contacto opcional)
        function sendWholeOrderWhatsApp() {
            if (carrito.length === 0) { mostrarAlertaModal('El carrito est√° vac√≠o'); return; }
            // N√∫mero destino configurado: 52 + 9241277313
            const telefono = '529241277313';
            let folio = Math.floor(1000 + Math.random() * 9000);
            
            let lines = [];
            lines.push(`üìù *PEDIDO #${folio}*`);
            lines.push('');
            
            let total = 0;
            let totalSobrePedido = 0;
            let productosSobrePedido = [];
            let productosNormales = [];
            
            // Separar productos normales y sobre pedido
            carrito.forEach((it) => {
                try {
                    const producto = listaProductos.find(p => p.id === it.id);
                    const esSobrePedido = producto && producto.categoria === 'sobrepedido';
                    const subtotal = (parseInt(it.cantidad,10) || 0) * it.precio;
                    total += subtotal;
                    
                    const itemText = `‚Ä¢ ${it.nombre} (${it.variante})\n  x${it.cantidad} - ${formatearDinero(subtotal)}`;
                    
                    if (esSobrePedido) {
                        productosSobrePedido.push(itemText);
                        totalSobrePedido += subtotal;
                    } else {
                        productosNormales.push(itemText);
                    }
                } catch (e) {
                    console.warn('Item inv√°lido en carrito:', e, it);
                }
            });
            
            // Agregar productos normales
            if (productosNormales.length > 0) {
                productosNormales.forEach(item => lines.push(item));
            }
            
            // Agregar productos sobre pedido
            if (productosSobrePedido.length > 0) {
                if (productosNormales.length > 0) lines.push('');
                lines.push('‚ö†Ô∏è *SOBRE PEDIDO:*');
                productosSobrePedido.forEach(item => lines.push(item));
                lines.push(`üíµ Anticipo (50%): *${formatearDinero(totalSobrePedido * 0.5)}*`);
                lines.push('üìÖ Entrega: ~7 d√≠as');
            }
            
            lines.push('');
            lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
            lines.push(`üí∞ *TOTAL: ${formatearDinero(total)}*`);
            
            let mensaje = lines.join('\n');
            
            const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;
            window.open(url, '_blank');
        }

        window.onload = function() { cargarCarritoDelStorage(); iniciarTicker(); renderizarMenuInicio(); actualizarBadgeCarrito(); };
    </script>
</body>
</html>

